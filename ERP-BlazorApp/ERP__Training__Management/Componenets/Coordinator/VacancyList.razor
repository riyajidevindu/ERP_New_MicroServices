
@using System.Net.Http.Json
@using MudBlazor
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar

@if (_internshipVacancies.Count > 0)
{
    <MudTable Items="@_internshipVacancies">
        <HeaderContent>
            <MudTh>Title</MudTh>
            <MudTh>Description</MudTh>
            <MudTh>Company</MudTh>
            <MudTh>Created Date</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Title">@context.Title</MudTd>
            <MudTd DataLabel="Description">@context.Description</MudTd>
            <MudTd DataLabel="Company">@context.Company</MudTd>
            <MudTd DataLabel="CreatedDate">@context.CreatedDate.ToString("yyyy-MM-dd")</MudTd>
            <MudTd DataLabel="Actions">
                <div class="button-group" style="@buttonGroupStyle">
                    <MudFab Color="Color.Secondary" OnClick="@(async () => await ShowVacancy(context.Id))"
                            StartIcon="@Icons.Material.Filled.Info" Size="Size.Small" />
                    <MudFab Color="Color.Primary" OnClick="@(async () => await EditVacancy(context.Id))"
                            StartIcon="@Icons.Material.Filled.Edit" Size="Size.Small" />
                    <MudFab Color="Color.Warning" OnClick="@(async () => await DeleteVacancy(context.Id))"
                            StartIcon="@Icons.Material.Filled.Delete" Size="Size.Small" />
                    <MudFab Color="Color.Tertiary" OnClick="() => NavigateToUploads(context.Id)"
                            StartIcon="@Icons.Material.Filled.UploadFile" Size="Size.Small" />
                </div>
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
}
else
{
    <MudProgressLinear Color="Color.Primary" Size="Size.Large" Indeterminate="true" Class="my-7" />
}

<MudMessageBox @ref="mbox" Title="Warning" CancelText="Cancel">
    <MessageContent>
        Are you sure you want to delete this internship vacancy?
    </MessageContent>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.DeleteForever">Delete!</MudButton>
    </YesButton>
</MudMessageBox>

@code {
    private string buttonGroupStyle = "display: flex; gap: 8px;";

    private HttpClient Http = new HttpClient();

    MudMessageBox mbox { get; set; }

    public EventCallback onDelete { get; set; }

    private List<InternshipVacancy> _internshipVacancies = new List<InternshipVacancy>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _internshipVacancies = await Http.GetFromJsonAsync<List<InternshipVacancy>>("https://localhost:7270/api/InternshipVacancy/Get");
        }
        catch (Exception ex)
        {
            _internshipVacancies = null;
            Snackbar.Add("Failed to load internship vacancies.", Severity.Error);
        }
    }

    private async Task ShowVacancy(Guid vacancyId)
    {
        var parameters = new DialogParameters { { "VacancyId", vacancyId } };

        var options = new DialogOptions
            {
                MaxWidth = MaxWidth.ExtraSmall,
                FullWidth = true,
                Position = DialogPosition.Center,
                CloseOnEscapeKey = true,
                CloseButton = true
            };

        var dialog = DialogService.Show<InternshipVacancyProfileDialog>("Vacancy Profile", parameters, options);
        await dialog.Result;
    }

    private async Task EditVacancy(Guid vacancyId)
    {
        var parameters = new DialogParameters { { "VacancyId", vacancyId } };

        var options = new DialogOptions
            {
                MaxWidth = MaxWidth.ExtraSmall,
                FullWidth = true,
                Position = DialogPosition.CenterLeft,
                CloseOnEscapeKey = true,
                CloseButton = true
            };

        var dialog = DialogService.Show<EditInternshipVacancyDialog>("Edit Vacancy", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            _internshipVacancies = await Http.GetFromJsonAsync<List<InternshipVacancy>>("https://localhost:7270/api/InternshipVacancy/Get");
        }
    }

    private async Task DeleteVacancy(Guid vacancyId)
    {
        bool? result = await mbox.ShowAsync();
        if (result == true)
        {
            var response = await Http.DeleteAsync($"https://localhost:7270/api/InternshipVacancy/{vacancyId}");

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Internship vacancy deleted successfully.", Severity.Success);
                _internshipVacancies = await Http.GetFromJsonAsync<List<InternshipVacancy>>("https://localhost:7270/api/InternshipVacancy/Get");
                StateHasChanged();
            }
            else
            {
                Snackbar.Add("Connection error. Internship vacancy not deleted.", Severity.Error);
            }
        }
        else
        {
            Snackbar.Add("Internship vacancy not deleted.", Severity.Info);
        }
    }
    private void NavigateToUploads(Guid VacancyId)
    {
        NavigationManager.NavigateTo($"/view-uploads/{VacancyId}");
    }
    public class InternshipVacancy
    {
        public Guid Id { get; set; }
        public string Title { get; set; }
        public string Description { get; set; }
        public string Company { get; set; }
        public DateTime CreatedDate { get; set; }
        public DateTime ModifiedDate { get; set; }
    }
}

